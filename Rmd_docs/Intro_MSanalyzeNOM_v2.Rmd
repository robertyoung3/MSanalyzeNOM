---
title: "Introduction to MSanalyzeNOM"
author: "Robert B. Young"
date: "6/11/2020"
output:
  html_notebook: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r set global options, include=FALSE}
options(digits = 8)
```

```{r load packages, include=FALSE}
library(MSanalyzeNOM)
```

```{r set sample data file location, echo=FALSE}
sample_xcel <- system.file("extdata", "This_is_a_PetroOrg_Excel_file.xls", 
                           package = "MSanalyzeNOM", mustWork = TRUE)
```



## Introduction

This document demonstrates R functions in the **{MSanalyzeNOM}** package for analyzing the mass spectrometry (MS) data of natural organic matter (NOM) samples after formula assignment. It was specifically created to analyze MS data from NOM samples analyzed by Fourier transform ion cyclotron resonance (FTICR) MS at the [National High Magnetic Field Laboratory](https://nationalmaglab.org/user-facilities/icr) (MagLab) in Tallahassee, Florida, USA. Usually, the analyses were  conducted using electrospray ionization in negative ion mode (NegESI), which is the default ion type in the MSanalyzeNOM package. In addition, the MSanalyzeNOM package generally assumes that the detected ions are singly-charged, based on literature describing the ESI-FTICR MS analysis of dissolved NOM (e.g., Stenson et al. 2002). 



## Reading MS Data from the MagLab

The MSanalyzeNOM package uses the *get_sample_data()* function to read Excel files exported by PetroOrg&copy; software, which was created at the MagLab for mass calibration, molecular formula assignment, and other purposes. The Excel file contains one or more sheets with summary data, a sheet with mass spectrometry data for detected ions that could not be assigned molecular formulas ("no hits"), and numerous sheets containing mass spectrometry data for the assigned molecular formulas, which have been grouped by heteroatom class (the number and identity of heteroatoms contained in the assigned molecular formulas). For example, $C_{6}H_{10}O_{5}$, $C_{7}H_{12}O_{5}$, and $C_{8}H_{14}O_{5}$ would be part of the "O5" heteroatom class, and $C_{11}H_{9}NO_{6}S$ would be part of the "N1 O6 S1" heteroatom class.

The *get_sample_data()* function returns a named list containing file and sample information, selected mass spectrometry parameters, mass spectrometry data related to the assigned molecular formulas, and mass spectrometry data related to detected ions that could not be assigned molecular formulas. Most of other functions in the MSanalyzeNOM package rely on column names produced by the *get_sample_data()* function. 

```{r run get_sample_data, message=FALSE}
# sample_xcel contains the path and filename of a sample Excel file for a DOM
# sample. if no path and filename are given, R's file.choose() function will
# permit you to choose a file
DOM_sample <- get_sample_data(sample_xcel)
```


#### Types of Sample Info

In particular, the named list contains fields for the sample name, ionization method, and list of elements used for formula assignment. These fields are saved for use in later calculations. For example, the sample name can be used in plot titles, and the ionization method can be used to compute neutral masses for assigned formulas. If no ionization method is specified, the default value is "NegESI" because it is the method we most commonly use at the MagLab.

```{r show sample info, message=FALSE}
DOM_sample$sample_name
DOM_sample$ion_technique
DOM_sample$elements_used
```


#### Changing the Sample Name

When the sample name is too detailed for a plot title, it can easily be changed.

```{r change sample_name}
DOM_sample$sample_name <- "DOM Sample 1"
DOM_sample$sample_name
```


#### Types of MS Data for the Assigned Formulas

The sheet containing the mass spectrometry data for the assigned formulas from PetroOrg&copy; is illustrated below. Much of this information is used to produce new details for data summary and visualization.  

```{r results get_sample_data, message=FALSE}
head(DOM_sample$assigned_formulas)
```


#### Changing the Element List

The table of elements was created from the list of elements that was used for formula assignment in PetroOrg&copy;. The default list of elements includes C, H, N, O and S, but a different element list can be specified. 

```{r change elements_used, message=FALSE}
sample_data <- get_sample_data(sample_xcel, elements_used = c("C", "H", "N", "O"))
sample_data[["elements_used"]]
```


#### Additional Details

Additional details for the *get_sample_data()* function can be examined by typing *"?get_sample_data"* in the R console.

```{r additional details, include=FALSE}
rm(sample_data)
```



## Computing Additional Useful Information

#### Elemental Classes

The elemental class (e.g., CHO or CHNOS) is useful for examining the assigned formulas as a function of their elemental content. The MSanalyzeNOM package uses the *get_CHNOS_element_class()* function to assign elemental classes for the default element list.

```{r get_CHNOS_element_class}
DOM_sample$assigned_formulas <- DOM_sample$assigned_formulas %>%
  get_CHNOS_element_class()
```

```{r results get_CHNOS_element_class, echo=FALSE}
DOM_sample$assigned_formulas %>%
  dplyr::select(-(DBE:S)) %>%
  head()
```

```{r count elemental class members, message=FALSE}
DOM_sample$assigned_formulas %>%  
  get_perc_abund() %>%
  dplyr::group_by(class_element) %>%
  dplyr::summarize(n = dplyr::n(), 
                   abund = sum(perc_abund))
```


#### DBE/C Ratios

[Estimate of aromaticity; Need computations for DBE & DBE/C]

The number of double bond equivalents (DBE) is the estimated number of rings and double bonds in a chemical compound. The basic calculation is:

>$$DBE = 1 + \frac{\sum_{i=1}^{n}N_i\left(V_i - 2\right)}{2}$$
>**where:**  
>$N_i$ = number of atom $i$  
>$V_i$ = valence of atom $i$  

A simpler calculation for several comment elements is the following:

>$$DBE = 1 - \frac{a}{2} + \frac{c}{2} + d$$  
>**where:**  
>$a$ = number of atoms with a valence of 1 (H, F, Cl, Br)  
>$b$ = number of atoms with a valency of 2 (O, S)  
>$c$ = number of atoms with a valency of 3 (N, P)  
>$d$ = number of atoms with a valency of 4 (C, Si) 

The basic DBE calculation has been [criticized](https://fiehnlab.ucdavis.edu/projects/seven-golden-rules/ring-double-bonds) because it fails to take multiple valence states into account. 

The MSanalyzeNOM package imports DBE values from PetroOrg&copy;, but they can also be computed using the *compute_DBE()* function. 

```{r compute_DBE}
# see about using element list to extract and row_across to sum; maybe also element list to select elements and valences
```

The DBE/C ratio estimates aromaticity by examining DBE as a function of the number of carbons. In this approach, DBE/C $\ge$ 0.5 suggests an aromatic structure, and DBE/C $\ge$ 0.67 suggests a condensed aromatic structure. In the MSanalyzeNOM package, the *compute_DBEtoC()* function calculates this ratio.

```{r compute_DBEtoC}

```


#### Aromaticity/Modified Aromaticity Index

The aromaticity index (AI) created by Koch & Dittmar (2006) offers a more conservative estimate of aromaticity than DBE/c because oxygen and other heteroatoms are deemed to form double bonds. Similar to the DBE/C ratio, AI $\ge$ 0.5 suggests an aromatic structure, and AI $\ge$ 0.67 suggests a condensed aromatic structure.

Because dissolved organic matter (DOM) frequently shows high carboxyl content when analyzed by NMR, the modified aromaticity index (ModAI) treats one-half of the oxygen as carboxyl oxygen, rather than carbonyl oxygen. This increases the number of compounds that qualify as aromatic or condensed aromatic, but is still more conservative than DBE/C ratios. 

The MSanalyze NOM package uses the *compute_arom_index()* function to compute the aromaticity/modified aromaticity index based on the specified AItype (default = "ModAI").

```{r compute_arom_index}

```

```{r compute_arom_index compare DBEtoC, AI & ModAI}
# Can facets be created when there is overlap?
```


#### AvgOSC (NOSC)

[]


#### Kendrick Mass Defect

[]


#### z score

[use z_CF2 with KMD_CF2 for PFCs]


#### Useful Elemental Ratios

The MSanalyzeNOM package uses the *get_elemental_ratios()* function to compute elemental ratios. The column name is derived from the numerator and denominator that are supplied.  "C" is the default denominator used for van Krevelen diagrams, but different elemental ratios can be used for other purposes. For example, Zark et al. 2017 have developed a method for estimating numbers of carboxyl groups from O/H ratios.

```{r get_elemental_ratios}
DOM_sample$assigned_formulas <- DOM_sample$assigned_formulas %>%
  get_elemental_ratios(num = "H") %>%
  get_elemental_ratios(num = "O") %>%
  get_elemental_ratios(num = "N") %>%
  get_elemental_ratios(num = "O", denom = "H")
```

```{r results get_elemental_ratios, echo=FALSE}
DOM_sample$assigned_formulas %>%
  dplyr::select(-(class_element:class_hetero), 
                -(mz:S)) %>%
  head()
```


#### Estimated Carboxyl Content

[]


## Visualizing the Data

#### Mass Spectrum

The mass spectrum plots the relative abundances of all detected ions, assigned and unassigned, and gives the least selective view of what could be ionized in the sample. However, it should be noted that sample preparation and ionization methods are also selective. The MSanalyzeNOM package uses the *plot_mass_spectrum()* function to plot a sample's mass spectrum.  

```{r plot_mass_spectrum}
plot_mass_spectrum(DOM_sample$all_detected_ions, 
                   plot_title = DOM_sample$sample_name)
```

NOM usually looks like a skewed Gaussian peak. As a result, any high abundance ions are at least suspected laboratory contaminants. In the preceding figure, the two most abundant compounds appear to be linear alkylbenzene sulfonate (LAS) surfactants, and the next two most abundant appear to be stearic and palmitic acids (which can be observed in high quality methanol).

```{r most abundant formulas, message=FALSE}
DOM_sample$assigned_formulas  %>% 
  dplyr::select(class_hetero:rel_abund) %>%
  dplyr::arrange(dplyr::desc(rel_abund)) %>%
  head(n = 10)
```

[remove contaminants and replot]

The *plot_mass_spectrum()* function contains optional parameters (min_x and max_x) to zoom in on a particular range in the mass spectrum. The m/z values were centroided in PetroOrg&copy;, so the abundances and spacing of the detected ions are clear, but not their mass resolution, which can be examined using [Predator Analysis](https://nationalmaglab.org/user-facilities/icr/icr-software) or PetroOrg&copy; software.

```{r plot_mass_spectrum narrow, message=FALSE, fig.height=3.5, fig.width=5}
plot_mass_spectrum(DOM_sample$all_detected_ions, 
                   plot_title = DOM_sample$sample_name,
                   min_x = 250.9, max_x = 251.2)
```


#### van Krevelen Diagrams (H/C vs. O/C)

A traditional van Krevelen diagram plots O/C vs. H/C. In general, high H/C ratios reflect a high degree of saturation,