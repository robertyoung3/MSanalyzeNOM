---
title: "Introduction to MSanalyzeNOM"
author: "Robert B. Young"
date: "6/11/2020"
output:
  html_notebook: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r set global options, include=FALSE}
options(digits = 8)
```

```{r load packages, include=FALSE}
library(MSanalyzeNOM)
```

```{r set sample data file location, echo=FALSE}
sample_xcel <- system.file("extdata", "This_is_a_PetroOrg_Excel_file.xls", 
                           package = "MSanalyzeNOM", mustWork = TRUE)
```



## Introduction

This document demonstrates R functions in the **{MSanalyzeNOM}** package for analyzing the mass spectrometry (MS) data of natural organic matter (NOM) samples after formula assignment. It was specifically created to analyze MS data from NOM samples analyzed by Fourier transform ion cyclotron resonance (FTICR) MS at the [National High Magnetic Field Laboratory](https://nationalmaglab.org/user-facilities/icr) (MagLab) in Tallahassee, Florida, USA. The MSanalyzeNOM package generally assumes that the detected ions are singly-charged, based on literature describing the ESI-FTICR MS analysis of dissolved NOM (e.g., Stenson et al. 2002). 



## Reading MS Data from the MagLab

The MSanalyzeNOM package uses the *get_sample_data()* function to read Excel files exported by PetroOrg&copy;, software that was created at the MagLab for mass calibration, molecular formula assignment, and other purposes. The Excel file contains sheets with summary data, a sheet with mass spectrometry data for detected ions that could not be assigned molecular formulas ("no hits"), and numerous sheets containing mass spectrometry data for the assigned molecular formulas, which have been separated by heteroatom class (the number and identity of heteroatoms contained in the assigned molecular formulas). For example, $C_{6}H_{10}O_{5}$, $C_{7}H_{12}O_{5}$, and $C_{8}H_{14}O_{5}$ are part of the "O5" heteroatom class, and $C_{11}H_{9}NO_{6}S$ is part of the "N1 O6 S1" heteroatom class.

The *get_sample_data()* function returns a named list containing file and sample information, selected mass spectrometry parameters, mass spectrometry data related to the assigned molecular formulas, and mass spectrometry data related to the "no hits". It also uses the *get_all_detected_ions()* function to combine the assigned formulas and "no hits" for plotting mass spectra.

```{r run get_sample_data, message=FALSE}
# sample_xcel contains the path and filename of a sample Excel file for a DOM sample. if no path and filename are given, 
# R's file.choose() function will permit you to choose a file
DOM_sample <- get_sample_data(sample_xcel)
```


#### Types of Sample Info

The named list contains fields for the sample name, ionization method, and elements used for formula assignment. These fields are saved for use in later calculations. For example, the sample name can be used in plot titles, and the ionization method can be used to compute neutral masses for assigned formulas. If no ionization method is specified, the default value is "NegESI" because it is more commonly used for NOM analysis (Ohno et al. 2016).

```{r show sample info, message=FALSE}
DOM_sample$sample_name
DOM_sample$ion_technique
DOM_sample$elements_used
```


#### Changing the Sample Name

When the sample name is too detailed for a plot title, it can easily be changed.

```{r change sample_name}
DOM_sample$sample_name <- "DOM Sample 1"
DOM_sample$sample_name
```


#### Types of MS Data for the Assigned Formulas

The sheet containing the mass spectrometry data for the assigned formulas from PetroOrg&copy; is illustrated below, and includes the chemical formula, its theoretical monoisotopic mass, the detected m/z, the mass error, the ion's relative abundance, and the ion's percent relative abundance. Much of this information, including the column names, is used by functions in the MSanalyzeNOM package to produce additional data and visualizations.

```{r results get_sample_data, message=FALSE}
head(DOM_sample$assigned_formulas)
```


#### Additional Details

Additional details for the *get_sample_data()* function can be examined by typing *"?get_sample_data"* in the R console.




## Examining and Visualizing the NOM Data

#### Composition by Elemental Class

The elemental class (e.g., CHO or CHNOS) is useful for examining the assigned formulas as a function of their elemental content. The MSanalyzeNOM package uses the *get_CHNOS_element_class()* function to assign elemental classes for the default element list.

```{r get_CHNOS_element_class}
DOM_sample$assigned_formulas <- DOM_sample$assigned_formulas %>%
  get_CHNOS_element_class()
```

```{r count elemental class members, message=FALSE}
DOM_sample$assigned_formulas %>%  
  compute_perc_abund() %>%
  dplyr::group_by(class_element) %>%
  dplyr::summarize(n = dplyr::n(), 
                   `% abund` = sum(perc_abund))
```

#### Mass Spectrum

The mass spectrum plots the relative abundances of all detected ions, assigned and unassigned, and gives the most comprehensive view of what could be ionized in the sample. However, it does not reflect the samples's entire composition because sample preparation and ionization methods are selective. The MSanalyzeNOM package uses the *plot_mass_spectrum()* function to plot a sample's mass spectrum. 

```{r plot_mass_spectrum}
plot_mass_spectrum(DOM_sample$all_detected_ions, 
                   plot_title = DOM_sample$sample_name)
```

The *plot_mass_spectrum()* function contains optional parameters (min_x and max_x) to zoom in on a particular range in the mass spectrum. The m/z values were centroided in PetroOrg&copy;, so the abundances and spacing of the detected ions are clear, but not their mass resolution, which can be examined using [Predator Analysis](https://nationalmaglab.org/user-facilities/icr/icr-software) or PetroOrg&copy; software.

```{r plot_mass_spectrum narrow, message=FALSE, fig.height=3.5, fig.width=5}
plot_mass_spectrum(DOM_sample$all_detected_ions, 
                   plot_title = DOM_sample$sample_name,
                   min_x = 250.9, max_x = 251.2)
```

NOM usually looks like a skewed Gaussian peak. As a result, any high abundance ions are at least suspected laboratory contaminants. In the preceding figure, the two most abundant compounds appear to be linear alkylbenzene sulfonate (LAS) surfactants, and the next two most abundant appear to be stearic and palmitic acids. The former are common laboratory contaminants associated with washing laboratory glassware, and the latter are common laboratory contaminants associated with LC-MS grade methanol.

```{r most abundant formulas, message=FALSE}
DOM_sample$assigned_formulas  %>% 
  dplyr::select(class_hetero, chem_formula, mz, ppm_error, rel_abund) %>%
  dplyr::arrange(dplyr::desc(rel_abund)) %>%
  head(n = 8)
```

Importantly, the numbers of detected ions and assigned formulas are sensitive to suppression from high abundance ions because the vast majority of detected ions occur at relatively low abundances. This can make comparisons between NOM samples challenging.


#### Double Bond Equivalents (DBE)

The number of double bond equivalents (DBE) is the estimated number of rings and double bonds in a chemical compound. The basic calculation is:

>$$DBE = 1 + \frac{\sum_{i=1}^{n}N_i\left(V_i - 2\right)}{2}$$
>**where:**  
>$N_i$ = number of element $i$  
>$V_i$ = valence of element $i$  

A simpler calculation for several comment elements is:

>$$DBE = 1 - \frac{a}{2} + \frac{c}{2} + d$$  
>**where:**  
>$a$ = number of atoms with a valence of 1 (H, F, Cl, Br)  
>$b$ = number of atoms with a valency of 2 (O, S)  
>$c$ = number of atoms with a valency of 3 (N, P)  
>$d$ = number of atoms with a valency of 4 (C, Si) 

The basic DBE calculation has been criticized because it fails to take [multiple valence states](https://fiehnlab.ucdavis.edu/projects/seven-golden-rules/ring-double-bonds) into account, and because rings and double bonds can also be formed with heteroatoms in DOM (Gonsior et al. 2009). 

The MSanalyzeNOM package imports DBE values from PetroOrg&copy;, but they can also be computed using the *compute_DBE()* function. The following code shows that they produce the same values.

```{r compute_DBE, message=FALSE}
reanalyzed_DOM_sample <- compute_DBE(DOM_sample$assigned_formulas, DOM_sample$elements_used)
identical(DOM_sample$assigned_formulas$DBE, reanalyzed_DOM_sample$DBE)
```

```{r clear reanalyzed_DOM_sample}
rm(reanalyzed_DOM_sample)
```


#### DBE/C Ratios

The DBE/C ratio estimates double bond density and aromaticity by normalizing DBE to the number of carbons. Under this approach, DBE/C $\ge$ 0.5 suggests an aromatic structure, and DBE/C $\ge$ 0.67 suggests a condensed aromatic structure. The MSanalyzeNOM package uses the *compute_DBEtoC()* function to calculate this ratio.

```{r compute_DBEtoC}
DOM_sample$assigned_formulas <- compute_DBEtoC(DOM_sample$assigned_formulas)
```

```{r results compute_DBEtoC, echo=FALSE}
DOM_sample$assigned_formulas %>%
  dplyr::select(chem_formula, DBE, C, DBEtoC) %>%
  head()
```

 
#### Aromaticity/Modified Aromaticity Index

The introduction of an O atom to a molecular formula does not change the number of DBEs, but reduces the number of C=C double bonds when C=O double bonds are present. Similarly, the introduction of an N atom (and corresponding H atom) reduces the number of C=C double bonds when C=N double bonds are present. 

The aromaticity index (AI) created by Koch & Dittmar (2006) assumes that heteroatoms form double bonds (e.g., O atoms form carbonyl groups), and offers a more conservative estimate of aromaticity. Similar to the DBE/C ratio, AI $\ge$ 0.5 suggests an aromatic structure, and AI $\ge$ 0.67 suggests a condensed aromatic structure.

Because dissolved organic matter (DOM) frequently shows high carboxyl content when analyzed by NMR spectroscopy, the modified aromaticity index (ModAI) treats one-half of the oxygen as carboxyl oxygen, rather than carbonyl oxygen. This increases the number of compounds that qualify as aromatic or condensed aromatic, but is still more conservative than DBE/C ratios. 

The MSanalyze NOM package uses the *compute_arom_index()* function to compute the aromaticity/modified aromaticity index based on the specified AItype (default = "ModAI"). Like Koch & Dittmar (2006), the aromaticity index calculations are based on common heteroatoms (N, O, P, S).

```{r compute_arom_index}
DOM_sample$assigned_formulas <- compute_arom_index(DOM_sample$assigned_formulas,
                                                   elements = DOM_sample$elements_used,
                                                   AItype = "AI")

DOM_sample$assigned_formulas <- compute_arom_index(DOM_sample$assigned_formulas,
                                                   elements = DOM_sample$elements_used,
                                                   AItype = "ModAI")
```

```{r results compute_arom_index, echo=FALSE}
DOM_sample$assigned_formulas %>%
  dplyr::select(chem_formula, DBE, C, DBEtoC, AI, ModAI) %>%
  head()
```

In [ChemSpider](http://www.chemspider.com/Search.aspx?q=C11H16O1), many of the proposed structures for $C_{11}H_{16}O$ are aromatic, so none of the aromaticity estimates are perfect predictors in every case. In fact, FTICR MS does not distinguish between isomers unless chromatography or fragmentation are employed, so the chemical formula $C_{11}H_{16}O$ could, in theory, represent a mixture of **all** the proposed structures in ChemSpider. 

A sample's aromaticity can be estimated by summing the percent relative abundances of sample components with aromaticity estimates $\ge$ 0.5. This estimate could be compared to percent aromaticity values from NMR spectroscopy, which quantifies functional group content in the entire NOM sample. 

```{r}
DOM_sample$assigned_formulas %>%
  dplyr::filter(ModAI <= 0.5) %>%
  dplyr::summarize(n = dplyr::n(), 
                   `% abund` = sum(perc_abund))
```


#### Useful Elemental Ratios

The MSanalyzeNOM package uses the *compute_elemental_ratios()* function to compute elemental ratios. The column name is derived from the numerator and denominator that are supplied.  "C" is the default denominator used for van Krevelen diagrams, but different elemental ratios can be used for other purposes. For example, Zark et al. 2017 have developed a method for estimating numbers of carboxyl groups from O/H ratios.

```{r compute_elemental_ratios}
DOM_sample$assigned_formulas <- DOM_sample$assigned_formulas %>%
  compute_elemental_ratios(num = "H") %>%
  compute_elemental_ratios(num = "O") %>%
  compute_elemental_ratios(num = "N") %>%
  compute_elemental_ratios(num = "O", denom = "H")
```

```{r results compute_elemental_ratios, echo=FALSE}
DOM_sample$assigned_formulas %>%
  dplyr::select(class_element, chem_formula, HtoC:OtoH) %>%
  head()
```


#### van Krevelen Diagrams (H/C vs. O/C)

A traditional van Krevelen diagram plots O/C vs. H/C ratios to reflect O and H densities in the sample. In general, high H/C ratios reflect a high degree of saturation, and low H/C ratios reflect the presence of rings and double bonds. Similarly, high O/C ratios reflect the relative presence of hydroxyl, carboxyl and other oxygen functional groups. To support interpretation, the area above the horizontal line at H/C = 1.5 has been designated as the aliphatic region in accordance with D'Andrilli et al. 2015 and Lv et al. 2017, and the area below the diagonal line from H/C = 1.1 has been  designated as the aromatic region, using the modified aromaticity index $\ge$ 0.5.


1. *Flat Diagram (No Information on Abundance)*

The following plot, created by the *plot_VK_flat()* function, shows the distribution of the assigned formulas as a function of their elemental ratios, but contains no information about the intensities of the detected ions. The darker areas are where the highest number of formulas are plotted.

```{r plot_VK_flat, fig.height=3.5, fig.width=4}
plot_VK_flat(DOM_sample$assigned_formulas, plot_title = DOM_sample$sample_name)
```

The *plot_VK_flat()* function can separate the assigned formulas by elemental class, or another factor variable, using the *panel* and *var_panel* arguments.

```{r plot_VK_flat class_element, fig.height=6, fig.width=7}
plot_VK_flat(DOM_sample$assigned_formulas, plot_title = DOM_sample$sample_name, panel = TRUE, var_panel = "class_element")
```

Just as DBE/C and the aromaticity indexes don't perfectly predict aromaticity, the lines on the van Krevelen diagram are approximations of aliphatic and aromatic content. When all of the points with a modified aromaticity index equal to 0.5 are plotted, they do not form a straight line.

```{r plot_VK_flat ModAI, fig.height=3.5, fig.width=4}
DOM_sample$assigned_formulas %>%
  dplyr::filter(ModAI == 0.5) %>%
  plot_VK_flat(plot_title = DOM_sample$sample_name)
```


2. *Color Gradient Based on Relative Abundances*

The *plot_VK_gradient()* function creates a van Krevelen diagram colored with a gradient based on their relative abundances. However, when a few assigned formulas are detected at comparatively high abundances, coloring the van Krevelen diagram in this way may not adequately resolve the NOM compounds with substantially lower abundances. 

```{r plot_VK_gradient, fig.height=3.5, fig.width=5}
plot_VK_gradient(DOM_sample$assigned_formulas, var = "rel_abund", 
                 plot_title = DOM_sample$sample_name)
```

If the highly abundant formulas are known (e.g., linear alkylbenzene sulfonate surfactants), the van Krevelen diagram can be re-plotted without them, as long as the figure is appropriately annotated. After removing the LAS surfactants and stearic and palmitic acids referenced above, the van Krevelen diagram offers better resolution. 

```{r replot VK_gradient, fig.height=3.5, fig.width=5}
# assigned_formulas and new_assigned_formulas should be segregated if saving
# DOM_sample
DOM_sample$new_assigned_formulas <- DOM_sample$assigned_formulas  %>% 
  dplyr::filter(!chem_formula %in% 
                c("C17H28O3S1", "C18H30O3S1", "C18H36O2", "C16H32O2")) %>%
  # normalize rel_abund to new highest value
  dplyr::mutate(rel_abund = rel_abund / max(rel_abund) * 100)
plot_VK_gradient(DOM_sample$new_assigned_formulas, var = "rel_abund", 
                 plot_title = DOM_sample$sample_name)
```


3. *Grouped by %Contribution to Abundance*

Another alternative for increasing resolution is to group assigned formulas by their percent contribution to total assigned abundance, and then plot the grouped formulas in a van Krevelen diagram. For example, all of the formulas that account for the top 25% of total abundance can be grouped together, and so on, until four distinct groups have been formed: "top 25%", "second 25%", "third 25%", and "bottom 25%". In this way, the high abundance laboratory contaminants can be grouped with the most abundant natural compounds, and their influence on the appearance of NOM components with substantially lower abundances can be limited.

```{r get_25perc_groups}
DOM_sample$assigned_formulas <- DOM_sample$assigned_formulas %>%
  get_25perc_groups()
```

The *plot_VK_25perc_groups()* function creates a van Krevelen diagram that is colored on this basis.

```{r plot_VK_25perc_groups, messages=FALSE, fig.height=3.5, fig.width=5}
plot_VK_25perc_groups(DOM_sample$assigned_formulas, plot_title = DOM_sample$sample_name)
```


This plot can be supplemented with data on the number of formulas in each category. In the sample plotted above, 1.5% of the formulas make up the first 25% of abundance, and 80.7% of the formulas make up the bottom 25%.

```{r formula number get_25perc_groups, message=FALSE}
temp <- DOM_sample$assigned_formulas  %>% 
  dplyr::group_by(group_25perc) %>% 
  dplyr::rename(group = group_25perc) %>%
  dplyr::summarize(`formulas` = dplyr::n())
temp
```

```{r data get_25perc_groups, message=FALSE, include=FALSE, results=FALSE}
temp[which(temp$group == "Top 25%"), ]$formulas / sum(temp$formulas) * 100
```

```{r data2 get_25perc_groups, message=FALSE, include=FALSE, results=FALSE}
temp[which(temp$group == "Bottom 25%"), ]$formulas / sum(temp$formulas) * 100
```

Like the flat VK diagram, the *plot_VK_25perc_groups()* function can separate the assigned formulas by elemental class using the *panel* and *var_panel* arguments.

```{r plot_VK_25perc_groups 25perc groups, messages=FALSE, warning=FALSE, fig.height=6, fig.width=7.5}
plot_VK_25perc_groups(DOM_sample$assigned_formulas, plot_title = DOM_sample$sample_name, panel = TRUE, var_panel = "class_element")
```


#### Kendrick Mass Defects and z* values

In mass spectrometry, mass defect is commonly defined as the difference between a compound's exact mass and its nominal mass (e.g., the theoretical monoisotopic mass of $C_{11}H_{16}O$ is 164.12012u, so it's mass defect is 0.12012u). $$^{12}C$$ is defined as having a zero mass defect ($$12.00000u - 12u$$). Other elemental isotopes have negative mass defects (e.g., $$^{16}O = 15.99491u - 16u$$ and $$^{35}Cl = 34.96885u - 35u$$), or positive mass defects (e.g., $$^{1}H = 1.00783u - 1u$$), with the result that each chemical formula has a relatively unique monoisotopic mass that can be detected with accurate mass measurement. Mass defects allow accurate formula assignment and confirmation from measured accurate masses, and facilitate the search for compounds of interest through mass defect filtering (Sleno 2011). 

Ordinarily, the members of a homologous series with a $$-CH_2-$$ repeating unit (e.g., LAS surfactants with different alkyl chain lengths) differ by a mass of 14.01565u, and a mass defect of 0.01565u. Kendrick masses (Kendrick 1963, Hughey et al. 2001) are computed by multiplying every accurate mass by 14u/14.01565u, so that members of the same $$-CH_2-$$ homologous series differ by a mass of 14.0000, and have identical Kendrick mass defects. The same logic can be applied to other repeating units such as $$CO_2$$ or $$H_2O$$.

The MSanalyzeNOM package uses the *compute_KMD_CH2()* function to compute Kendrick mass defects (KMD) for measured or theoretical mass where $$-CH_2-$$ (14.01565u) is the repeating unit. The theoretical Kendrick mass defects will be identical, subject to rounding errors, and the measured Kendrick mass defects will reflect additional measurement errors. The *compute_KMD_CH2()* function produces separate column names for measured and theoretical Kendrick mass defects. In addition, the number of digits can be specified to limit or explore rounding errors in the KMD calculation.

Because it is possible for different homologous series to have very similar KMDs, or identical KMDs due to rounding, z* values also separate compounds by their membership in a nominal mass series. For example, the members of a homologous series with a $$-CH_2-$$ repeating unit differ from each other by a nominal mass of 14u. The *compute_z_CH2()* function produces up to 14 unique z* values to ensure that members of the same $$-CH_2-$$ homologous series differ by a nominal mass of 14u.

```{r compute_KMD_CH2}
DOM_sample$assigned_formulas <- DOM_sample$assigned_formulas %>%
  compute_z_CH2() %>%
  compute_KMD_CH2(selection = "meas", num_digits = 5) %>%
  compute_KMD_CH2(selection = "theor")
```

```{r results compute_KMD_CH2}
DOM_sample$assigned_formulas %>%
  dplyr::arrange(class_element, O, KMD_CH2_theor, mz) %>%
  dplyr::select(chem_formula, mz, theor_mz, z_CH2, KMD_CH2_meas, KMD_CH2_theor) %>%
  head()
```

The linear alkylbenzyl sulfonate (LAS) surfactants have a CH2 repeating unit, and a theoretical Kendrick mass defect equal to 0.1788, but the N4 O3 heteroatom class also contains a homologous series with a theoretical Kendrick mass defect equal to 0.1788. Because they are members of different 14u nominal mass series, the LAS surfactants can be separated from the N4 O3 heteroatom class by their Z* values, or by their heteroatom class because formula assignments have already been made.

```{r KMD LAS}
DOM_sample$assigned_formulas %>%
  dplyr::filter(KMD_CH2_theor == 0.1788) %>%
  dplyr::select(class_hetero, chem_formula, mz, rel_abund, 
                z_CH2, KMD_CH2_meas, KMD_CH2_theor) %>%
  dplyr::arrange(z_CH2, dplyr::desc(rel_abund))
```

The MSanalyzeNOM package uses the *remove_common_contaminants()* function to remove LAS surfactants and stearic and palmitic acids from the assigned formulas for improving the visualization of less abundant NOM components. It relies, in part, on the computed z_CH2 and KMD_CH2_theor values to identify the entire LAS surfactant series. The *remove_common_contaminants()* function should only be used with appropriate annotation and discussion, and the edited table of formulas should be segregated from the unedited data in DOM_sample. Importantly, removing the contaminants does not remove their influence on the other detected ions and assigned formulas, which can be reduced in number from the presence of high abundance contaminants.

```{r remove_common_contaminants}
DOM_sample$new_assigned_formulas <- DOM_sample$assigned_formulas  %>% 
  remove_common_contaminants()
```


#### Average Oxidation State of Carbon

The average oxidation state of carbon (AvgOSC), or nominal oxidation state of carbon (NOSC), can be used to demonstrate the extent of oxidation in an NOM sample (Kroll et al. 2011), or to illustrate its thermodynamic favorability for oxidative degradation (Boye et al. 2017). The *compute_AvgOSC()* function computes the average oxidation state of carbon based on the following formula (Kroll et al. 2011, Riedel et al. 2012., and Lavonen et al. 2013):

>$$AvgOSC = -\sum_{i=1}^{n}OS_i\frac{n_i}{n_C}$$
>**where:**  
>$OS_i$ = oxidation state of non-carbon element $i$  
>$n_i$ = number of non-carbon element $i$  
>$n_C$ = number of carbon atoms  

A simpler calculation for several comment elements is:

>$$- \frac{h âˆ’ 3n - 2o - 2s}{c}
>**where:**  
>$c$ = number of carbon atoms  
>$h$ = number of hydrogen atoms  
>$n$ = number of nitrogen atoms  
>$o$ = number of oxygen atoms 
>$s$ = number of sulfur atoms 

It is currently limited to the default element list, and specifically excludes P which has several common oxidation states (i.e., -3, 3, and 5). 

```{r compute_AvgOSC, warning=FALSE}
DOM_sample$assigned_formulas <- compute_AvgOSC(DOM_sample$assigned_formulas,
                                               elements = DOM_sample$elements_used)
```

```{r results compute_AvgOSC}
DOM_sample$assigned_formulas %>%
  dplyr::arrange(class_element, O, mz) %>%
  dplyr::select(chem_formula, AvgOSC) %>%
  head(n = 8)
```


#### Kroll Diagram

[describe and plot Kroll diagram]



## Reproducible Data Analysis

An R markdown notebook, such as this, or an R programming script should be saved with the "raw" FTICR MS data (e.g., the Excel file esported by PetroOrg&copy;) to facilitate reproducible analysis of the FTICR MS data. The *DOM_sample* named list can also be stored as a separate R object to avoid reprocessing the "raw" FTICR MS data. 